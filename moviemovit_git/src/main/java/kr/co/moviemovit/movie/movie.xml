<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- namespace="팩키지.인터페이스" -->
<mapper namespace="kr.co.moviemovit.movie.MovieMapper">

    <insert id="create" parameterType="MovieDTO">
        <selectKey keyProperty="mCode" resultType="int" order="BEFORE">
			<![CDATA[
				SELECT IFNULL(MAX(mCode),0) + 1 AS mCode
				FROM movieTable
			]]>	
		</selectKey>
		    <![CDATA[	
				INSERT INTO movieTable(mCode, poster, mName, genre, screen, age, s_e, country, director, actor, DD, runningTime, s_date, e_date)
				VALUES(#{mCode}, #{poster}, #{mName}, #{genre}, #{screen}, #{age}, #{s_e}, #{country}, #{director}, #{actor}, #{DD}, #{runningTime}, #{s_date}, #{e_date})                        
			]]>	
	</insert>
	
	<select id="list" resultType="MovieDTO">
		<![CDATA[
			SELECT mCode, poster, mName, genre, screen, age, s_e, country, director, actor, DD, runningTime, s_date, e_date
			FROM movieTable
			ORDER BY s_date DESC	
		]]>
	</select>
	
	<select id="list2" resultType="StarDTO">
	    <![CDATA[
	        select mt.*, st.star
            from (SELECT mCode, (select avg(star) from starTable) star
                  FROM starTable) st join movieTable mt
            ON mt.mCode = st.mCode
            WHERE st.mCode=#{mCode}
        ]]>
	</select>
	
	<resultMap type="StarDTO" id="StarDTO">
	    <result column="mCode" property="mCode"/>
	    <result column="star"  property="star"/>
    </resultMap>

    <resultMap type="MovieDTO" id="MovieDTO">
    	<result column="mCode"        property="mCode"/>
        <result column="poster"       property="poster"/>
        <result column="mName"        property="mName"/>
        <result column="genre"        property="genre"/>
        <result column="screen"       property="screen"/>
        <result column="age"          property="age"/>
        <result column="s_e"          property="s_e"/>
        <result column="country"      property="country"/>
        <result column="director"     property="director"/>
        <result column="actor"        property="actor"/>
        <result column="DD"           property="DD"/>
        <result column="runningTime"  property="runningTime"/>
        <result column="s_date"       property="s_date"/>
        <result column="e_date"       property="e_date"/>
    	<collection property="mCode" resultMap="StarDTO"/>
    </resultMap>

    <select id="starlist" parameterType="MovieDTO" resultType="MovieDTO">
       <![CDATA[
       	  select mt.mCode, poster, mName, genre, screen, age, s_e, country, director, actor, DD, s_date, e_date, avg(star) as runningTime 
          from movieTable mt join starTable st
          ON mt.mCode = st.mCode
          GROUP BY mt.mCode
       ]]>
    </select>

	
	<select id="read" parameterType="MovieDTO" resultType="MovieDTO">
		<![CDATA[
			SELECT mCode, poster, mName, genre, screen, age, s_e, country, director, actor, DD, runningTime, s_date, e_date
			FROM movieTable
			WHERE mCode = #{mCode}
		]]>	
	</select>
	
	
    <delete id="delete" parameterType="MovieDTO">
		<![CDATA[
			DELETE FROM movieTable
			WHERE mCode = #{mCode}
		]]>	
	</delete>	
	
	<update id="update" parameterType="MovieDTO" >
	    <![CDATA[
			UPDATE movieTable
			SET	poster=#{poster}, mName=#{mName}, genre=#{genre}, screen=#{screen}, age=#{age}, s_e=#{s_e}, country=#{country}, director=#{director}, actor=#{actor}, DD=#{DD}, runningTime=#{runningTime}, s_date=#{s_date}, e_date=#{e_date}
			WHERE mCode = #{mCode}
		]]>	
	</update>
	
	<select id="peopleNameList" parameterType="String" resultType="PeopleDTO">
      <![CDATA[
        SELECT peoCode, peoName, country, peoBirth, gender, peoPic
        FROM peopleTable
        WHERE peoName LIKE concat('%', #{peoName}, '%')
        ORDER BY peoName DESC
      ]]>
    </select>
    
    <select id="peopleNameList2" parameterType="String" resultType="PeopleDTO">
      <![CDATA[
        SELECT peoCode, peoName, country, peoBirth, gender, peoPic
        FROM peopleTable
        WHERE peoName LIKE concat('%', #{peoName}, '%')
        ORDER BY peoName DESC
      ]]>
    </select>
    
    <select id="avgstar" resultType="int">
      <![CDATA[
		SELECT (select avg(star) from starTable) AS avgstar
	    FROM starTable
	    
	    GROUP BY mCode
      ]]>    
    </select>
    
    
	
	
</mapper>





